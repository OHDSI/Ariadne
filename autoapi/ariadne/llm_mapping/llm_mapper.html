
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="concept_context_retriever.html">
      
      
        <link rel="next" href="../term_cleanup/index.html">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>llm_mapper - Ariadne Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.618322db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ariadne.llm_mapping.llm_mapper" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../index.html" title="Ariadne Documentation" class="md-header__button md-logo" aria-label="Ariadne Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Ariadne Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              llm_mapper
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../index.html" title="Ariadne Documentation" class="md-nav__button md-logo" aria-label="Ariadne Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Ariadne Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Notebooks
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Notebooks
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notebooks/01_evaluate_exact_mapping.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Evaluation of the exact matching pipeline
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" checked>
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    ariadne
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    ariadne
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1_1" id="__nav_3_1_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    evaluation
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    evaluation
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../evaluation/concept_search_evaluator.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    concept_search_evaluator
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../evaluation/concept_selection_evaluator.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    concept_selection_evaluator
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_2" checked>
        
          
          <label class="md-nav__link" for="__nav_3_1_2" id="__nav_3_1_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    llm_mapping
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_1_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    llm_mapping
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="concept_context_retriever.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    concept_context_retriever
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    llm_mapper
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="llm_mapper.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    llm_mapper
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ariadne.llm_mapping.llm_mapper" class="md-nav__link">
    <span class="md-ellipsis">
      
        llm_mapper
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ariadne.llm_mapping.llm_mapper.LlmMapper" class="md-nav__link">
    <span class="md-ellipsis">
      
        LlmMapper
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LlmMapper">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ariadne.llm_mapping.llm_mapper.LlmMapper.get_total_cost" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_total_cost
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ariadne.llm_mapping.llm_mapper.LlmMapper.map_term" class="md-nav__link">
    <span class="md-ellipsis">
      
        map_term
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ariadne.llm_mapping.llm_mapper.LlmMapper.map_terms" class="md-nav__link">
    <span class="md-ellipsis">
      
        map_terms
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_3" >
        
          
          <label class="md-nav__link" for="__nav_3_1_3" id="__nav_3_1_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    term_cleanup
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    term_cleanup
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../term_cleanup/term_cleaner.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    term_cleaner
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_4" >
        
          
          <label class="md-nav__link" for="__nav_3_1_4" id="__nav_3_1_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    utils
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    utils
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/config.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    config
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/gen_ai_api.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    gen_ai_api
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/logger.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    logger
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/utils.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    utils
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_5" >
        
          
          <label class="md-nav__link" for="__nav_3_1_5" id="__nav_3_1_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    vector_search
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    vector_search
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vector_search/abstract_concept_searcher.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    abstract_concept_searcher
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vector_search/hecate_concept_searcher.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    hecate_concept_searcher
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vector_search/pgvector_concept_searcher.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    pgvector_concept_searcher
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_6" >
        
          
          <label class="md-nav__link" for="__nav_3_1_6" id="__nav_3_1_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    verbatim_mapping
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    verbatim_mapping
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../verbatim_mapping/term_downloader.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    term_downloader
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../verbatim_mapping/term_normalizer.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    term_normalizer
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../verbatim_mapping/verbatim_term_mapper.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    verbatim_term_mapper
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../verbatim_mapping/vocab_verbatim_term_mapper.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    vocab_verbatim_term_mapper
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ariadne.llm_mapping.llm_mapper" class="md-nav__link">
    <span class="md-ellipsis">
      
        llm_mapper
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ariadne.llm_mapping.llm_mapper.LlmMapper" class="md-nav__link">
    <span class="md-ellipsis">
      
        LlmMapper
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LlmMapper">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ariadne.llm_mapping.llm_mapper.LlmMapper.get_total_cost" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_total_cost
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ariadne.llm_mapping.llm_mapper.LlmMapper.map_term" class="md-nav__link">
    <span class="md-ellipsis">
      
        map_term
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ariadne.llm_mapping.llm_mapper.LlmMapper.map_terms" class="md-nav__link">
    <span class="md-ellipsis">
      
        map_terms
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



  <h1>llm_mapper</h1>

<div class="doc doc-object doc-module">



<a id="ariadne.llm_mapping.llm_mapper"></a>
    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="ariadne.llm_mapping.llm_mapper.LlmMapper" class="doc doc-heading">
            <code>LlmMapper</code>


</h2>


    <div class="doc doc-contents ">










              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/ariadne/llm_mapping/llm_mapper.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LlmMapper</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system_prompts</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">llm_mapping</span><span class="o">.</span><span class="n">system_prompts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_settings</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">llm_mapping</span><span class="o">.</span><span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses_folder</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">llm_mapper_responses_folder</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">responses_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cost</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the LlmMapper with configuration settings, specific system prompts, and context settings for </span>
<span class="sd">        LLM-based term mapping. Also sets up a folder to store LLM responses.</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">map_term</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">source_term</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">source_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">target_concepts</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">concept_id_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;matched_concept_id&quot;</span><span class="p">,</span>
        <span class="n">concept_name_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;matched_concept_name&quot;</span><span class="p">,</span>
        <span class="n">domain_id_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;matched_domain_id&quot;</span><span class="p">,</span>
        <span class="n">concept_class_id_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;matched_concept_class_id&quot;</span><span class="p">,</span>
        <span class="n">vocabulary_id_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;matched_vocabulary_id&quot;</span><span class="p">,</span>
        <span class="n">parents_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;matched_parents&quot;</span><span class="p">,</span>
        <span class="n">children_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;matched_children&quot;</span><span class="p">,</span>
        <span class="n">synonyms_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;matched_synonyms&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Maps a source term to the matching target concept using LLM prompts. The LLM can be prompted in multiple</span>
<span class="sd">        steps. The first step provides the source term and candidate target concepts as prompt, with information</span>
<span class="sd">        specified in config.llm_mapping.context. Subsequent steps use the response from the previous step as prompt,</span>
<span class="sd">        unless config.llm_mapping.context.re_insert_target_details is set to True, in which case the target concept</span>
<span class="sd">        details are re-inserted into the response JSON for the next step.</span>

<span class="sd">        Finally, the response is processed to extract the matched concept ID and name, looking for a line starting with</span>
<span class="sd">        &quot;Match: &lt;concept_id&gt;&quot; or &quot;Match: no_match&quot;.</span>

<span class="sd">        Args:</span>
<span class="sd">            source_term: The source clinical term to map.</span>
<span class="sd">            source_id: An optional unique identifier for the source term, used for caching responses.</span>
<span class="sd">            target_concepts: A DataFrame containing candidate target concepts with columns:</span>
<span class="sd">            concept_id_column: The name of the column containing target concept IDs.</span>
<span class="sd">            concept_name_column: The name of the column containing target concept names.</span>
<span class="sd">            domain_id_column: The name of the column containing target domain IDs.</span>
<span class="sd">            concept_class_id_column: The name of the column containing target concept class IDs.</span>
<span class="sd">            vocabulary_id_column: The name of the column containing target vocabulary IDs.</span>
<span class="sd">            parents_column: The name of the column containing target concept parents.</span>
<span class="sd">            children_column: The name of the column containing target concept children.</span>
<span class="sd">            synonyms_column: The name of the column containing target concept synonyms.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple of (matched_concept_id, matched_concept_name, match_rationale). If no match is found, returns</span>
<span class="sd">            (-1, &quot;no_match&quot;, &quot;&quot;). If the content filter is hit, returns (None, None, None).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">num_prompts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system_prompts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">source_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">source_id</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">source_term</span><span class="p">))</span> <span class="o">%</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">8</span><span class="p">)</span>

        <span class="n">input_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">concept_id_column</span><span class="p">,</span> <span class="n">concept_name_column</span><span class="p">]</span>
        <span class="n">context_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;concept_id&quot;</span><span class="p">,</span> <span class="s2">&quot;concept_name&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_settings</span><span class="o">.</span><span class="n">include_target_class</span><span class="p">:</span>
            <span class="n">input_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concept_class_id_column</span><span class="p">)</span>
            <span class="n">context_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;concept_class_id&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_settings</span><span class="o">.</span><span class="n">include_target_parents</span><span class="p">:</span>
            <span class="n">input_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parents_column</span><span class="p">)</span>
            <span class="n">context_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;concept_parents&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_settings</span><span class="o">.</span><span class="n">include_target_domain</span><span class="p">:</span>
            <span class="n">input_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">domain_id_column</span><span class="p">)</span>
            <span class="n">context_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;concept_domain&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_settings</span><span class="o">.</span><span class="n">include_target_vocabulary</span><span class="p">:</span>
            <span class="n">input_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vocabulary_id_column</span><span class="p">)</span>
            <span class="n">context_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;concept_vocabulary&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_settings</span><span class="o">.</span><span class="n">include_target_children</span><span class="p">:</span>
            <span class="n">input_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">children_column</span><span class="p">)</span>
            <span class="n">context_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;concept_children&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_settings</span><span class="o">.</span><span class="n">include_target_synonyms</span><span class="p">:</span>
            <span class="n">input_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">synonyms_column</span><span class="p">)</span>
            <span class="n">context_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;concept_synonyms&quot;</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">target_concepts</span><span class="p">[</span><span class="n">input_columns</span><span class="p">]</span>
        <span class="n">context</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">context_columns</span>

        <span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_prompts</span><span class="p">):</span>
            <span class="n">response_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">responses_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;response_</span><span class="si">{</span><span class="n">source_id</span><span class="si">}</span><span class="s2">_s</span><span class="si">{</span><span class="n">step</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>

            <span class="c1"># Load response from file if it exists:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">response_file</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">response_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;*Content filter triggered*&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Else generate a new response from the LLM:</span>
                <span class="n">system_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompts</span><span class="p">[</span><span class="n">step</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">context_json</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">,</span> <span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Source term: </span><span class="si">{</span><span class="n">source_term</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Candidate target concepts:</span><span class="se">\n</span><span class="si">{</span><span class="n">context_json</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="n">response_with_usage</span> <span class="o">=</span> <span class="n">get_llm_response</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">system_prompt</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">response_with_usage</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">:</span>
                    <span class="c1"># We hit the content filter:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">response_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;*Content filter triggered*&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cost</span> <span class="o">+</span> <span class="n">response_with_usage</span><span class="p">[</span><span class="s2">&quot;usage&quot;</span><span class="p">][</span><span class="s2">&quot;total_cost_usd&quot;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_settings</span><span class="o">.</span><span class="n">re_insert_target_details</span><span class="p">:</span>
                    <span class="c1"># Re-insert target details into the response JSON for the next step:</span>
                    <span class="n">response_json_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;{.*}&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">response_json_match</span><span class="p">:</span>
                        <span class="n">response_json_str</span> <span class="o">=</span> <span class="n">response_json_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response_json_str</span><span class="p">)</span>
                            <span class="n">target_definitions</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;target_concepts&quot;</span><span class="p">]</span>
                            <span class="n">target_definitions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">target_definitions</span><span class="p">)</span>
                            <span class="n">target_definitions</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">target_definitions</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
                            <span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                                <span class="n">target_definitions</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;concept_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
                            <span class="p">)</span>
                            <span class="n">merged</span> <span class="o">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;concept_id&quot;</span><span class="p">])</span>
                            <span class="n">new_data</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s2">&quot;source_term&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;source_term&quot;</span><span class="p">],</span>
                                <span class="s2">&quot;target_concepts&quot;</span><span class="p">:</span> <span class="n">merged</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">),</span>
                            <span class="p">}</span>
                            <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not re-insert target details: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">response_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">&lt;</span> <span class="n">num_prompts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Use the response as the prompt for the next step:</span>
                <span class="n">prompt</span> <span class="o">=</span> <span class="n">response</span>

        <span class="c1"># Process the final response to extract the match:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^#+ ?Match ?:.*&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;no[ _]match|-1&quot;</span><span class="p">,</span> <span class="n">match</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
                <span class="n">match_value_int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">concept_name</span> <span class="o">=</span> <span class="s2">&quot;no_match&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">number_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span> <span class="n">match</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">number_match</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No numeric match found in response: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">number_match_value</span> <span class="o">=</span> <span class="n">number_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">match_value_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">number_match_value</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Match value &#39;</span><span class="si">{</span><span class="n">number_match_value</span><span class="si">}</span><span class="s2">&#39; is not a valid integer.&quot;</span><span class="p">)</span>
                <span class="n">matched_row</span> <span class="o">=</span> <span class="n">target_concepts</span><span class="p">[</span><span class="n">target_concepts</span><span class="p">[</span><span class="n">concept_id_column</span><span class="p">]</span> <span class="o">==</span> <span class="n">match_value_int</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">matched_row</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Match &#39;</span><span class="si">{</span><span class="n">number_match_value</span><span class="si">}</span><span class="s2">&#39; not found in search results.&quot;</span><span class="p">)</span>
                <span class="n">concept_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">matched_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">concept_name_column</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;:\s?(no[ _]match|-1)&quot;</span><span class="p">,</span> <span class="n">match</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
            <span class="n">match_value_int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">concept_name</span> <span class="o">=</span> <span class="s2">&quot;no_match&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Response does not contain a match or no_match.&quot;</span><span class="p">)</span>

        <span class="c1"># Extract the rationale if provided.</span>
        <span class="n">rationale_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Justification[:\-]?(.*)&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="n">rationale</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">rationale_match</span><span class="p">:</span>
            <span class="n">rationale</span> <span class="o">=</span> <span class="n">rationale_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">rationale</span> <span class="o">=</span> <span class="n">rationale</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">match_value_int</span><span class="p">,</span> <span class="n">concept_name</span><span class="p">,</span> <span class="n">rationale</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">map_terms</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">source_target_concepts</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">term_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cleaned_term&quot;</span><span class="p">,</span>
        <span class="n">source_id_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;source_concept_id&quot;</span><span class="p">,</span>
        <span class="n">source_term_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;source_term&quot;</span><span class="p">,</span>
        <span class="n">concept_id_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;matched_concept_id&quot;</span><span class="p">,</span>
        <span class="n">concept_name_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;matched_concept_name&quot;</span><span class="p">,</span>
        <span class="n">domain_id_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;matched_domain_id&quot;</span><span class="p">,</span>
        <span class="n">concept_class_id_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;matched_concept_class_id&quot;</span><span class="p">,</span>
        <span class="n">vocabulary_id_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;matched_vocabulary_id&quot;</span><span class="p">,</span>
        <span class="n">parents_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;matched_parents&quot;</span><span class="p">,</span>
        <span class="n">children_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;matched_children&quot;</span><span class="p">,</span>
        <span class="n">synonyms_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;matched_synonyms&quot;</span><span class="p">,</span>
        <span class="n">mapped_concept_id_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mapped_concept_id&quot;</span><span class="p">,</span>
        <span class="n">mapped_concept_name_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mapped_concept_name&quot;</span><span class="p">,</span>
        <span class="n">mapped_rationale_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mapped_rationale&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Maps source terms in a DataFrame column to target concepts using LLM prompts. The system prompts are taken</span>
<span class="sd">        from the configuration file. Multiple steps are supported as per the map_term method.</span>

<span class="sd">        The input DataFrame should contain multiple rows per source term, one for each candidate target concept.</span>

<span class="sd">        Be aware that LLM responses are cached based on source term and source ID, so if the same term appears</span>
<span class="sd">        multiple times with the same source ID, the cached response will be used. The cache is stored in the</span>
<span class="sd">        llm_mapper_responses_folder specified in the config.</span>

<span class="sd">        Args:</span>
<span class="sd">            source_target_concepts: DataFrame containing the source clinical terms and candidate target concepts.</span>
<span class="sd">            term_column: The name of the column containing source terms fed to the LLM.</span>
<span class="sd">            source_id_column: The name of the column containing the unique source term IDs.</span>
<span class="sd">            source_term_column: The name of the column containing the original source terms.</span>
<span class="sd">            concept_id_column: The name of the column containing the target concept IDs.</span>
<span class="sd">            concept_name_column: The name of the column containing the target concept names.</span>
<span class="sd">            domain_id_column: The name of the column containing the target domain IDs.</span>
<span class="sd">            concept_class_id_column: The name of the column containing the target concept class IDs.</span>
<span class="sd">            vocabulary_id_column: The name of the column containing the target vocabulary IDs.</span>
<span class="sd">            parents_column: The name of the column containing the target concept parents.</span>
<span class="sd">            children_column: The name of the column containing the target concept children.</span>
<span class="sd">            synonyms_column: The name of the column containing the target concept synonyms.</span>
<span class="sd">            mapped_concept_id_column: The name of the output column for mapped concept IDs.</span>
<span class="sd">            mapped_concept_name_column: The name of the output column for mapped concept names.</span>
<span class="sd">            mapped_rationale_column: The name of the output column for mapping rationale.</span>
<span class="sd">        Returns:</span>
<span class="sd">            A DataFrame with the original terms and their mapped concept IDs and names.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">mapped_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="n">source_target_concepts</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">term_column</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">term</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
            <span class="n">source_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">source_id_column</span> <span class="ow">and</span> <span class="n">source_id_column</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">source_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">source_id_column</span><span class="p">])</span>
            <span class="n">matched_concept_id</span><span class="p">,</span> <span class="n">matched_concept_name</span><span class="p">,</span> <span class="n">match_rationale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_term</span><span class="p">(</span>
                <span class="n">term</span><span class="p">,</span>
                <span class="n">source_id</span><span class="p">,</span>
                <span class="n">group</span><span class="p">,</span>
                <span class="n">concept_id_column</span><span class="p">,</span>
                <span class="n">concept_name_column</span><span class="p">,</span>
                <span class="n">domain_id_column</span><span class="p">,</span>
                <span class="n">concept_class_id_column</span><span class="p">,</span>
                <span class="n">vocabulary_id_column</span><span class="p">,</span>
                <span class="n">parents_column</span><span class="p">,</span>
                <span class="n">children_column</span><span class="p">,</span>
                <span class="n">synonyms_column</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">matched_concept_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Content filter was hit:</span>
                <span class="k">continue</span>
            <span class="n">mapped_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="n">term_column</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span>
                    <span class="n">source_id_column</span><span class="p">:</span> <span class="n">source_id</span><span class="p">,</span>
                    <span class="n">source_term_column</span><span class="p">:</span> <span class="n">group</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">source_term_column</span><span class="p">],</span>
                    <span class="n">mapped_concept_id_column</span><span class="p">:</span> <span class="n">matched_concept_id</span><span class="p">,</span>
                    <span class="n">mapped_concept_name_column</span><span class="p">:</span> <span class="n">matched_concept_name</span><span class="p">,</span>
                    <span class="n">mapped_rationale_column</span><span class="p">:</span> <span class="n">match_rationale</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mapped_data</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_total_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the total cost incurred for LLM calls</span>

<span class="sd">        Returns:</span>
<span class="sd">            Total cost in USD.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cost</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="ariadne.llm_mapping.llm_mapper.LlmMapper.get_total_cost" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_total_cost</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Returns the total cost incurred for LLM calls</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Total cost in USD.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/ariadne/llm_mapping/llm_mapper.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_total_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the total cost incurred for LLM calls</span>

<span class="sd">    Returns:</span>
<span class="sd">        Total cost in USD.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cost</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ariadne.llm_mapping.llm_mapper.LlmMapper.map_term" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">map_term</span><span class="p">(</span><span class="n">source_term</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">target_concepts</span><span class="p">,</span> <span class="n">concept_id_column</span><span class="o">=</span><span class="s1">&#39;matched_concept_id&#39;</span><span class="p">,</span> <span class="n">concept_name_column</span><span class="o">=</span><span class="s1">&#39;matched_concept_name&#39;</span><span class="p">,</span> <span class="n">domain_id_column</span><span class="o">=</span><span class="s1">&#39;matched_domain_id&#39;</span><span class="p">,</span> <span class="n">concept_class_id_column</span><span class="o">=</span><span class="s1">&#39;matched_concept_class_id&#39;</span><span class="p">,</span> <span class="n">vocabulary_id_column</span><span class="o">=</span><span class="s1">&#39;matched_vocabulary_id&#39;</span><span class="p">,</span> <span class="n">parents_column</span><span class="o">=</span><span class="s1">&#39;matched_parents&#39;</span><span class="p">,</span> <span class="n">children_column</span><span class="o">=</span><span class="s1">&#39;matched_children&#39;</span><span class="p">,</span> <span class="n">synonyms_column</span><span class="o">=</span><span class="s1">&#39;matched_synonyms&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Maps a source term to the matching target concept using LLM prompts. The LLM can be prompted in multiple
steps. The first step provides the source term and candidate target concepts as prompt, with information
specified in config.llm_mapping.context. Subsequent steps use the response from the previous step as prompt,
unless config.llm_mapping.context.re_insert_target_details is set to True, in which case the target concept
details are re-inserted into the response JSON for the next step.</p>
<p>Finally, the response is processed to extract the matched concept ID and name, looking for a line starting with
"Match: <concept_id>" or "Match: no_match".</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>source_term</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The source clinical term to map.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>source_id</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An optional unique identifier for the source term, used for caching responses.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>target_concepts</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A DataFrame containing candidate target concepts with columns:</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>concept_id_column</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the column containing target concept IDs.</p>
              </div>
            </td>
            <td>
                  <code>&#39;matched_concept_id&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>concept_name_column</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the column containing target concept names.</p>
              </div>
            </td>
            <td>
                  <code>&#39;matched_concept_name&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>domain_id_column</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the column containing target domain IDs.</p>
              </div>
            </td>
            <td>
                  <code>&#39;matched_domain_id&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>concept_class_id_column</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the column containing target concept class IDs.</p>
              </div>
            </td>
            <td>
                  <code>&#39;matched_concept_class_id&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>vocabulary_id_column</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the column containing target vocabulary IDs.</p>
              </div>
            </td>
            <td>
                  <code>&#39;matched_vocabulary_id&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>parents_column</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the column containing target concept parents.</p>
              </div>
            </td>
            <td>
                  <code>&#39;matched_parents&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>children_column</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the column containing target concept children.</p>
              </div>
            </td>
            <td>
                  <code>&#39;matched_children&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>synonyms_column</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the column containing target concept synonyms.</p>
              </div>
            </td>
            <td>
                  <code>&#39;matched_synonyms&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple of (matched_concept_id, matched_concept_name, match_rationale). If no match is found, returns</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(-1, "no_match", ""). If the content filter is hit, returns (None, None, None).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/ariadne/llm_mapping/llm_mapper.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">map_term</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">source_term</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">source_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">target_concepts</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">concept_id_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;matched_concept_id&quot;</span><span class="p">,</span>
    <span class="n">concept_name_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;matched_concept_name&quot;</span><span class="p">,</span>
    <span class="n">domain_id_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;matched_domain_id&quot;</span><span class="p">,</span>
    <span class="n">concept_class_id_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;matched_concept_class_id&quot;</span><span class="p">,</span>
    <span class="n">vocabulary_id_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;matched_vocabulary_id&quot;</span><span class="p">,</span>
    <span class="n">parents_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;matched_parents&quot;</span><span class="p">,</span>
    <span class="n">children_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;matched_children&quot;</span><span class="p">,</span>
    <span class="n">synonyms_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;matched_synonyms&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Maps a source term to the matching target concept using LLM prompts. The LLM can be prompted in multiple</span>
<span class="sd">    steps. The first step provides the source term and candidate target concepts as prompt, with information</span>
<span class="sd">    specified in config.llm_mapping.context. Subsequent steps use the response from the previous step as prompt,</span>
<span class="sd">    unless config.llm_mapping.context.re_insert_target_details is set to True, in which case the target concept</span>
<span class="sd">    details are re-inserted into the response JSON for the next step.</span>

<span class="sd">    Finally, the response is processed to extract the matched concept ID and name, looking for a line starting with</span>
<span class="sd">    &quot;Match: &lt;concept_id&gt;&quot; or &quot;Match: no_match&quot;.</span>

<span class="sd">    Args:</span>
<span class="sd">        source_term: The source clinical term to map.</span>
<span class="sd">        source_id: An optional unique identifier for the source term, used for caching responses.</span>
<span class="sd">        target_concepts: A DataFrame containing candidate target concepts with columns:</span>
<span class="sd">        concept_id_column: The name of the column containing target concept IDs.</span>
<span class="sd">        concept_name_column: The name of the column containing target concept names.</span>
<span class="sd">        domain_id_column: The name of the column containing target domain IDs.</span>
<span class="sd">        concept_class_id_column: The name of the column containing target concept class IDs.</span>
<span class="sd">        vocabulary_id_column: The name of the column containing target vocabulary IDs.</span>
<span class="sd">        parents_column: The name of the column containing target concept parents.</span>
<span class="sd">        children_column: The name of the column containing target concept children.</span>
<span class="sd">        synonyms_column: The name of the column containing target concept synonyms.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple of (matched_concept_id, matched_concept_name, match_rationale). If no match is found, returns</span>
<span class="sd">        (-1, &quot;no_match&quot;, &quot;&quot;). If the content filter is hit, returns (None, None, None).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">num_prompts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system_prompts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">source_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">source_id</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">source_term</span><span class="p">))</span> <span class="o">%</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">8</span><span class="p">)</span>

    <span class="n">input_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">concept_id_column</span><span class="p">,</span> <span class="n">concept_name_column</span><span class="p">]</span>
    <span class="n">context_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;concept_id&quot;</span><span class="p">,</span> <span class="s2">&quot;concept_name&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_settings</span><span class="o">.</span><span class="n">include_target_class</span><span class="p">:</span>
        <span class="n">input_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concept_class_id_column</span><span class="p">)</span>
        <span class="n">context_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;concept_class_id&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_settings</span><span class="o">.</span><span class="n">include_target_parents</span><span class="p">:</span>
        <span class="n">input_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parents_column</span><span class="p">)</span>
        <span class="n">context_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;concept_parents&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_settings</span><span class="o">.</span><span class="n">include_target_domain</span><span class="p">:</span>
        <span class="n">input_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">domain_id_column</span><span class="p">)</span>
        <span class="n">context_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;concept_domain&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_settings</span><span class="o">.</span><span class="n">include_target_vocabulary</span><span class="p">:</span>
        <span class="n">input_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vocabulary_id_column</span><span class="p">)</span>
        <span class="n">context_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;concept_vocabulary&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_settings</span><span class="o">.</span><span class="n">include_target_children</span><span class="p">:</span>
        <span class="n">input_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">children_column</span><span class="p">)</span>
        <span class="n">context_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;concept_children&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_settings</span><span class="o">.</span><span class="n">include_target_synonyms</span><span class="p">:</span>
        <span class="n">input_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">synonyms_column</span><span class="p">)</span>
        <span class="n">context_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;concept_synonyms&quot;</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">target_concepts</span><span class="p">[</span><span class="n">input_columns</span><span class="p">]</span>
    <span class="n">context</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">context_columns</span>

    <span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_prompts</span><span class="p">):</span>
        <span class="n">response_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">responses_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;response_</span><span class="si">{</span><span class="n">source_id</span><span class="si">}</span><span class="s2">_s</span><span class="si">{</span><span class="n">step</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>

        <span class="c1"># Load response from file if it exists:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">response_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">response_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;*Content filter triggered*&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Else generate a new response from the LLM:</span>
            <span class="n">system_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompts</span><span class="p">[</span><span class="n">step</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">context_json</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">,</span> <span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Source term: </span><span class="si">{</span><span class="n">source_term</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Candidate target concepts:</span><span class="se">\n</span><span class="si">{</span><span class="n">context_json</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">response_with_usage</span> <span class="o">=</span> <span class="n">get_llm_response</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">system_prompt</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">response_with_usage</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">:</span>
                <span class="c1"># We hit the content filter:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">response_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;*Content filter triggered*&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cost</span> <span class="o">+</span> <span class="n">response_with_usage</span><span class="p">[</span><span class="s2">&quot;usage&quot;</span><span class="p">][</span><span class="s2">&quot;total_cost_usd&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_settings</span><span class="o">.</span><span class="n">re_insert_target_details</span><span class="p">:</span>
                <span class="c1"># Re-insert target details into the response JSON for the next step:</span>
                <span class="n">response_json_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;{.*}&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">response_json_match</span><span class="p">:</span>
                    <span class="n">response_json_str</span> <span class="o">=</span> <span class="n">response_json_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response_json_str</span><span class="p">)</span>
                        <span class="n">target_definitions</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;target_concepts&quot;</span><span class="p">]</span>
                        <span class="n">target_definitions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">target_definitions</span><span class="p">)</span>
                        <span class="n">target_definitions</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">target_definitions</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
                        <span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                            <span class="n">target_definitions</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;concept_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
                        <span class="p">)</span>
                        <span class="n">merged</span> <span class="o">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;concept_id&quot;</span><span class="p">])</span>
                        <span class="n">new_data</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;source_term&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;source_term&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;target_concepts&quot;</span><span class="p">:</span> <span class="n">merged</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">),</span>
                        <span class="p">}</span>
                        <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not re-insert target details: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">response_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">step</span> <span class="o">&lt;</span> <span class="n">num_prompts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Use the response as the prompt for the next step:</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="n">response</span>

    <span class="c1"># Process the final response to extract the match:</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^#+ ?Match ?:.*&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;no[ _]match|-1&quot;</span><span class="p">,</span> <span class="n">match</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
            <span class="n">match_value_int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">concept_name</span> <span class="o">=</span> <span class="s2">&quot;no_match&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">number_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span> <span class="n">match</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">number_match</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No numeric match found in response: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">number_match_value</span> <span class="o">=</span> <span class="n">number_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">match_value_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">number_match_value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Match value &#39;</span><span class="si">{</span><span class="n">number_match_value</span><span class="si">}</span><span class="s2">&#39; is not a valid integer.&quot;</span><span class="p">)</span>
            <span class="n">matched_row</span> <span class="o">=</span> <span class="n">target_concepts</span><span class="p">[</span><span class="n">target_concepts</span><span class="p">[</span><span class="n">concept_id_column</span><span class="p">]</span> <span class="o">==</span> <span class="n">match_value_int</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">matched_row</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Match &#39;</span><span class="si">{</span><span class="n">number_match_value</span><span class="si">}</span><span class="s2">&#39; not found in search results.&quot;</span><span class="p">)</span>
            <span class="n">concept_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">matched_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">concept_name_column</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;:\s?(no[ _]match|-1)&quot;</span><span class="p">,</span> <span class="n">match</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
        <span class="n">match_value_int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">concept_name</span> <span class="o">=</span> <span class="s2">&quot;no_match&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Response does not contain a match or no_match.&quot;</span><span class="p">)</span>

    <span class="c1"># Extract the rationale if provided.</span>
    <span class="n">rationale_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Justification[:\-]?(.*)&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
    <span class="n">rationale</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">rationale_match</span><span class="p">:</span>
        <span class="n">rationale</span> <span class="o">=</span> <span class="n">rationale_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">rationale</span> <span class="o">=</span> <span class="n">rationale</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">match_value_int</span><span class="p">,</span> <span class="n">concept_name</span><span class="p">,</span> <span class="n">rationale</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ariadne.llm_mapping.llm_mapper.LlmMapper.map_terms" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">map_terms</span><span class="p">(</span><span class="n">source_target_concepts</span><span class="p">,</span> <span class="n">term_column</span><span class="o">=</span><span class="s1">&#39;cleaned_term&#39;</span><span class="p">,</span> <span class="n">source_id_column</span><span class="o">=</span><span class="s1">&#39;source_concept_id&#39;</span><span class="p">,</span> <span class="n">source_term_column</span><span class="o">=</span><span class="s1">&#39;source_term&#39;</span><span class="p">,</span> <span class="n">concept_id_column</span><span class="o">=</span><span class="s1">&#39;matched_concept_id&#39;</span><span class="p">,</span> <span class="n">concept_name_column</span><span class="o">=</span><span class="s1">&#39;matched_concept_name&#39;</span><span class="p">,</span> <span class="n">domain_id_column</span><span class="o">=</span><span class="s1">&#39;matched_domain_id&#39;</span><span class="p">,</span> <span class="n">concept_class_id_column</span><span class="o">=</span><span class="s1">&#39;matched_concept_class_id&#39;</span><span class="p">,</span> <span class="n">vocabulary_id_column</span><span class="o">=</span><span class="s1">&#39;matched_vocabulary_id&#39;</span><span class="p">,</span> <span class="n">parents_column</span><span class="o">=</span><span class="s1">&#39;matched_parents&#39;</span><span class="p">,</span> <span class="n">children_column</span><span class="o">=</span><span class="s1">&#39;matched_children&#39;</span><span class="p">,</span> <span class="n">synonyms_column</span><span class="o">=</span><span class="s1">&#39;matched_synonyms&#39;</span><span class="p">,</span> <span class="n">mapped_concept_id_column</span><span class="o">=</span><span class="s1">&#39;mapped_concept_id&#39;</span><span class="p">,</span> <span class="n">mapped_concept_name_column</span><span class="o">=</span><span class="s1">&#39;mapped_concept_name&#39;</span><span class="p">,</span> <span class="n">mapped_rationale_column</span><span class="o">=</span><span class="s1">&#39;mapped_rationale&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Maps source terms in a DataFrame column to target concepts using LLM prompts. The system prompts are taken
from the configuration file. Multiple steps are supported as per the map_term method.</p>
<p>The input DataFrame should contain multiple rows per source term, one for each candidate target concept.</p>
<p>Be aware that LLM responses are cached based on source term and source ID, so if the same term appears
multiple times with the same source ID, the cached response will be used. The cache is stored in the
llm_mapper_responses_folder specified in the config.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>source_target_concepts</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing the source clinical terms and candidate target concepts.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>term_column</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the column containing source terms fed to the LLM.</p>
              </div>
            </td>
            <td>
                  <code>&#39;cleaned_term&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>source_id_column</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the column containing the unique source term IDs.</p>
              </div>
            </td>
            <td>
                  <code>&#39;source_concept_id&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>source_term_column</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the column containing the original source terms.</p>
              </div>
            </td>
            <td>
                  <code>&#39;source_term&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>concept_id_column</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the column containing the target concept IDs.</p>
              </div>
            </td>
            <td>
                  <code>&#39;matched_concept_id&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>concept_name_column</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the column containing the target concept names.</p>
              </div>
            </td>
            <td>
                  <code>&#39;matched_concept_name&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>domain_id_column</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the column containing the target domain IDs.</p>
              </div>
            </td>
            <td>
                  <code>&#39;matched_domain_id&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>concept_class_id_column</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the column containing the target concept class IDs.</p>
              </div>
            </td>
            <td>
                  <code>&#39;matched_concept_class_id&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>vocabulary_id_column</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the column containing the target vocabulary IDs.</p>
              </div>
            </td>
            <td>
                  <code>&#39;matched_vocabulary_id&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>parents_column</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the column containing the target concept parents.</p>
              </div>
            </td>
            <td>
                  <code>&#39;matched_parents&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>children_column</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the column containing the target concept children.</p>
              </div>
            </td>
            <td>
                  <code>&#39;matched_children&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>synonyms_column</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the column containing the target concept synonyms.</p>
              </div>
            </td>
            <td>
                  <code>&#39;matched_synonyms&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mapped_concept_id_column</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the output column for mapped concept IDs.</p>
              </div>
            </td>
            <td>
                  <code>&#39;mapped_concept_id&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mapped_concept_name_column</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the output column for mapped concept names.</p>
              </div>
            </td>
            <td>
                  <code>&#39;mapped_concept_name&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mapped_rationale_column</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the output column for mapping rationale.</p>
              </div>
            </td>
            <td>
                  <code>&#39;mapped_rationale&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    A DataFrame with the original terms and their mapped concept IDs and names.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/ariadne/llm_mapping/llm_mapper.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">map_terms</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">source_target_concepts</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">term_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cleaned_term&quot;</span><span class="p">,</span>
    <span class="n">source_id_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;source_concept_id&quot;</span><span class="p">,</span>
    <span class="n">source_term_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;source_term&quot;</span><span class="p">,</span>
    <span class="n">concept_id_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;matched_concept_id&quot;</span><span class="p">,</span>
    <span class="n">concept_name_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;matched_concept_name&quot;</span><span class="p">,</span>
    <span class="n">domain_id_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;matched_domain_id&quot;</span><span class="p">,</span>
    <span class="n">concept_class_id_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;matched_concept_class_id&quot;</span><span class="p">,</span>
    <span class="n">vocabulary_id_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;matched_vocabulary_id&quot;</span><span class="p">,</span>
    <span class="n">parents_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;matched_parents&quot;</span><span class="p">,</span>
    <span class="n">children_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;matched_children&quot;</span><span class="p">,</span>
    <span class="n">synonyms_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;matched_synonyms&quot;</span><span class="p">,</span>
    <span class="n">mapped_concept_id_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mapped_concept_id&quot;</span><span class="p">,</span>
    <span class="n">mapped_concept_name_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mapped_concept_name&quot;</span><span class="p">,</span>
    <span class="n">mapped_rationale_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mapped_rationale&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Maps source terms in a DataFrame column to target concepts using LLM prompts. The system prompts are taken</span>
<span class="sd">    from the configuration file. Multiple steps are supported as per the map_term method.</span>

<span class="sd">    The input DataFrame should contain multiple rows per source term, one for each candidate target concept.</span>

<span class="sd">    Be aware that LLM responses are cached based on source term and source ID, so if the same term appears</span>
<span class="sd">    multiple times with the same source ID, the cached response will be used. The cache is stored in the</span>
<span class="sd">    llm_mapper_responses_folder specified in the config.</span>

<span class="sd">    Args:</span>
<span class="sd">        source_target_concepts: DataFrame containing the source clinical terms and candidate target concepts.</span>
<span class="sd">        term_column: The name of the column containing source terms fed to the LLM.</span>
<span class="sd">        source_id_column: The name of the column containing the unique source term IDs.</span>
<span class="sd">        source_term_column: The name of the column containing the original source terms.</span>
<span class="sd">        concept_id_column: The name of the column containing the target concept IDs.</span>
<span class="sd">        concept_name_column: The name of the column containing the target concept names.</span>
<span class="sd">        domain_id_column: The name of the column containing the target domain IDs.</span>
<span class="sd">        concept_class_id_column: The name of the column containing the target concept class IDs.</span>
<span class="sd">        vocabulary_id_column: The name of the column containing the target vocabulary IDs.</span>
<span class="sd">        parents_column: The name of the column containing the target concept parents.</span>
<span class="sd">        children_column: The name of the column containing the target concept children.</span>
<span class="sd">        synonyms_column: The name of the column containing the target concept synonyms.</span>
<span class="sd">        mapped_concept_id_column: The name of the output column for mapped concept IDs.</span>
<span class="sd">        mapped_concept_name_column: The name of the output column for mapped concept names.</span>
<span class="sd">        mapped_rationale_column: The name of the output column for mapping rationale.</span>
<span class="sd">    Returns:</span>
<span class="sd">        A DataFrame with the original terms and their mapped concept IDs and names.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mapped_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">grouped</span> <span class="o">=</span> <span class="n">source_target_concepts</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">term_column</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">term</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
        <span class="n">source_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">source_id_column</span> <span class="ow">and</span> <span class="n">source_id_column</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">source_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">source_id_column</span><span class="p">])</span>
        <span class="n">matched_concept_id</span><span class="p">,</span> <span class="n">matched_concept_name</span><span class="p">,</span> <span class="n">match_rationale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_term</span><span class="p">(</span>
            <span class="n">term</span><span class="p">,</span>
            <span class="n">source_id</span><span class="p">,</span>
            <span class="n">group</span><span class="p">,</span>
            <span class="n">concept_id_column</span><span class="p">,</span>
            <span class="n">concept_name_column</span><span class="p">,</span>
            <span class="n">domain_id_column</span><span class="p">,</span>
            <span class="n">concept_class_id_column</span><span class="p">,</span>
            <span class="n">vocabulary_id_column</span><span class="p">,</span>
            <span class="n">parents_column</span><span class="p">,</span>
            <span class="n">children_column</span><span class="p">,</span>
            <span class="n">synonyms_column</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">matched_concept_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Content filter was hit:</span>
            <span class="k">continue</span>
        <span class="n">mapped_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="n">term_column</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span>
                <span class="n">source_id_column</span><span class="p">:</span> <span class="n">source_id</span><span class="p">,</span>
                <span class="n">source_term_column</span><span class="p">:</span> <span class="n">group</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">source_term_column</span><span class="p">],</span>
                <span class="n">mapped_concept_id_column</span><span class="p">:</span> <span class="n">matched_concept_id</span><span class="p">,</span>
                <span class="n">mapped_concept_name_column</span><span class="p">:</span> <span class="n">matched_concept_name</span><span class="p">,</span>
                <span class="n">mapped_rationale_column</span><span class="p">:</span> <span class="n">match_rationale</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mapped_data</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>